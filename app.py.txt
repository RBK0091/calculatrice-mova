import streamlit as st

# Configuration de la page
st.set_page_config(page_title="Calculatrice MDB - MOVA", page_icon="üè¢")

st.title("üè¢ Calculatrice Rentabilit√© MDB")
st.markdown("---")

# --- 1. DONN√âES D'ENTR√âE (INPUTS) ---
st.header("1. Acquisition & Projet")

col1, col2 = st.columns(2)
with col1:
    surface = st.number_input("Surface (m¬≤)", value=46.0, step=1.0)
    prix_offre = st.number_input("Prix Offre (‚Ç¨)", value=240000, step=1000)
    frais_agence_acq = st.number_input("Frais Agence Achat (‚Ç¨)", value=0, step=500)

with col2:
    duree_mois = st.slider("Dur√©e du projet (mois)", min_value=6, max_value=24, value=12)
    # Anticipation proactive : Retard possible
    retard_mois = st.slider("Anticipation Retard (mois)", 0, 12, 0)
    prix_revente_m2 = st.number_input("Prix Revente estim√© (‚Ç¨/m¬≤)", value=10500, step=100)

# --- 2. TRAVAUX & ETUDES ---
st.header("2. Travaux & √âtudes")
type_reno = st.selectbox("Type de R√©novation", 
                         ["Rafraichissement (400-800‚Ç¨)", "R√©novation Simple (1200-1400‚Ç¨)", "Lourde (1500-1800‚Ç¨)", "Luxe (>2000‚Ç¨)"])

col3, col4 = st.columns(2)
with col3:
    cout_travaux_m2 = st.number_input("Co√ªt Travaux (‚Ç¨/m¬≤)", value=1500, step=50)
    # Frais annexes fixes selon tes fichiers
    geometre = st.number_input("G√©om√®tre (‚Ç¨)", value=1000)
    ingenieur = st.number_input("Ing√©nieur B√©ton (‚Ç¨)", value=1000)

with col4:
    age_frais = st.number_input("Frais AGE (‚Ç¨)", value=2000)
    permis = st.number_input("Permis / DP (‚Ç¨)", value=0)
    architecte = st.number_input("Architecte (MOVA = 0‚Ç¨)", value=0)

# --- 3. CALCULS AUTOMATIQUES (FORMULES MOVA) ---

# Calculs interm√©diaires
budget_travaux = surface * cout_travaux_m2
honoraires_conducteur = budget_travaux * 0.05  # 5% conducteur chantier
total_travaux_etudes = budget_travaux + honoraires_conducteur + geometre + ingenieur + age_frais + permis + architecte

# Frais Notaire (estim√© √† 7.5% si classique, ou entr√©e manuelle si besoin, ici calcul auto pour rapidit√©)
frais_notaire = prix_offre * 0.075 

# Enveloppe Globale "Physique" (Achat + Frais + Travaux) pour base de calcul bancaire
enveloppe_physique = prix_offre + frais_agence_acq + frais_notaire + total_travaux_etudes

# --- FRAIS FINANCIERS & MOVA ---
# Frais Bancaire Dossier 1.5%
frais_bancaire_dossier = prix_offre * 0.015 

# Hypoth√®que (Forfait moyen)
frais_hypotheque = 1500 + (prix_offre * 0.003) # Estimation proactive
frais_levee = 1500 # Forfait

# Frais de Portage : 7% sur 75% de l'enveloppe globale
# Attention : calcul√© sur la dur√©e TOTALE (initiale + retard)
duree_totale = duree_mois + retard_mois
base_portage = enveloppe_physique * 0.75
cout_portage = base_portage * 0.07 * (duree_totale / 12)

# Frais SEP : 2% montant du projet
# Le "montant du projet" inclut g√©n√©ralement tout sauf la marge.
frais_sep = enveloppe_physique * 0.02 

# Frais Courants (Taxe fonci√®re, √©lectricit√©...)
# Estimation : ~200‚Ç¨/mois (Proactif : mieux vaut surestimer)
frais_courants = 200 * duree_totale

# CO√õT TOTAL DE L'OP√âRATION
total_cout = (enveloppe_physique + frais_bancaire_dossier + frais_hypotheque + 
              frais_levee + cout_portage + frais_sep + frais_courants)

# REVENTE
prix_revente_total = surface * prix_revente_m2
frais_agence_revente = prix_revente_total * 0.04 # Est. 4% ou forfait
net_vendeur = prix_revente_total - frais_agence_revente

# MARGE
marge_net = net_vendeur - total_cout
pourcentage_marge = (marge_net / total_cout) * 100

# --- 4. R√âSULTATS ---
st.markdown("---")
st.header("üìä R√©sultats de l'Op√©ration")

col_res1, col_res2, col_res3 = st.columns(3)
col_res1.metric("Co√ªt Total Projet", f"{total_cout:,.0f} ‚Ç¨")
col_res2.metric("Net Vendeur", f"{net_vendeur:,.0f} ‚Ç¨")
col_res3.metric("Marge Nette (‚Ç¨)", f"{marge_net:,.0f} ‚Ç¨", delta_color="normal")

st.markdown(f"### üìà Rentabilit√© : **{pourcentage_marge:.2f} %**")

if pourcentage_marge < 25:
    st.error("‚ö†Ô∏è Attention : Marge inf√©rieure √† 25% (Objectif MDB Partenaire)")
elif pourcentage_marge < 40:
    st.warning("‚úÖ Bon projet (Standard). Marge < 40% (Objectif Club MOVA)")
else:
    st.success("üöÄ Excellent projet ! Marge > 40%")

# D√©tails des co√ªts pour analyse
with st.expander("Voir le d√©tail des co√ªts (Cliquer pour d√©plier)"):
    st.write(f"**Acquisition :** {prix_offre + frais_notaire + frais_agence_acq:,.0f} ‚Ç¨")
    st.write(f"**Travaux & √âtudes :** {total_travaux_etudes:,.0f} ‚Ç¨")
    st.write(f"**Frais Bancaires & Portage :** {frais_bancaire_dossier + cout_portage + frais_hypotheque:,.0f} ‚Ç¨")
    st.write(f"dont Co√ªt Portage (7%): {cout_portage:,.0f} ‚Ç¨")
    st.write(f"**Frais SEP (2%) :** {frais_sep:,.0f} ‚Ç¨")
    st.write(f"**Frais Courants :** {frais_courants:,.0f} ‚Ç¨")